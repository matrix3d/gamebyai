<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 拥挤的小人 (费马螺旋排列)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: sans-serif;
            user-select: none; /* 防止点击时选中文本 */
        }
        #info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            color: white;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
            font-size: 18px;
            z-index: 10;
        }
        canvas {
            display: block;
        }
    </style>
    <!-- 使用 Import Map 引入 Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>

    <div id="info">
        点击任意位置放置小人<br>
        <span style="font-size: 14px; opacity: 0.8">算法：费马螺旋 (Fermat's Spiral)</span>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. 场景初始化 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // 天空蓝
        scene.fog = new THREE.Fog(0x87CEEB, 20, 80);

        // --- 2. 摄像机 ---
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 40, 40); // 抬高相机，方便俯视
        camera.lookAt(0, 0, 0);

        // --- 3. 渲染器 ---
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- 4. 灯光 ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(20, 30, 10);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.left = -50;
        dirLight.shadow.camera.right = 50;
        dirLight.shadow.camera.top = 50;
        dirLight.shadow.camera.bottom = -50;
        scene.add(dirLight);

        // --- 5. 地面 ---
        const planeGeometry = new THREE.PlaneGeometry(200, 200);
        const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x99cc99, roughness: 0.8 });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        // --- 6. 小人配置 ---
        const people = []; 
        const PERSON_RADIUS = 0.8; 
        const PERSON_HEIGHT = 2;   
        
        // 关键算法参数
        // 黄金角：约 137.5 度
        const GOLDEN_ANGLE = Math.PI * (3 - Math.sqrt(5)); 
        // 间距系数：比直径 (1.6) 稍微大一点，留点缝隙
        const SPACING = 1.8; 

        // 创建小人的函数
        function createPerson(x, z) {
            const group = new THREE.Group();

            // 身体
            const bodyGeo = new THREE.CylinderGeometry(PERSON_RADIUS, PERSON_RADIUS, PERSON_HEIGHT, 16);
            const bodyMat = new THREE.MeshStandardMaterial({ 
                color: new THREE.Color().setHSL(Math.random(), 0.7, 0.5) // 随机鲜艳颜色
            });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = PERSON_HEIGHT / 2;
            body.castShadow = true;
            body.receiveShadow = true;
            group.add(body);

            // 头
            const headGeo = new THREE.SphereGeometry(PERSON_RADIUS, 16, 16);
            const headMat = new THREE.MeshStandardMaterial({ color: 0xffccaa });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = PERSON_HEIGHT + PERSON_RADIUS * 0.8;
            head.castShadow = true;
            group.add(head);

            // 动画效果：刚出现时从小变大
            group.scale.set(0,0,0);
            
            group.position.set(x, 0, z);
            scene.add(group);
            
            people.push({ mesh: group, scaleParam: 0 });
        }

        // --- 7. 点击交互 (应用算法) ---
        window.addEventListener('pointerdown', (event) => {
            // 获取当前是第几个人 (n)
            const n = people.length;

            // --- 核心算法：费马螺旋 ---
            
            // 1. 计算极坐标半径 r = c * sqrt(n)
            // (第0个人半径为0，在正中心)
            const r = SPACING * Math.sqrt(n);

            // 2. 计算角度 theta = n * 137.5度
            const theta = n * GOLDEN_ANGLE;

            // 3. 转换为笛卡尔坐标 (x, z)
            const x = r * Math.cos(theta);
            const z = r * Math.sin(theta);

            // 生成
            createPerson(x, z);
        });

        // --- 8. 动画循环 ---
        function animate() {
            requestAnimationFrame(animate);

            // 简单的弹跳/出现动画
            people.forEach(p => {
                if (p.mesh.scale.x < 1) {
                    p.mesh.scale.x += 0.1;
                    p.mesh.scale.y += 0.1;
                    p.mesh.scale.z += 0.1;
                    // 简单的弹性效果
                    if (p.mesh.scale.x > 1) p.mesh.scale.set(1,1,1);
                }
                // 让小人稍微朝向中心看
                p.mesh.lookAt(0, p.mesh.position.y, 0);
            });

            renderer.render(scene, camera);
        }

        animate();

        // --- 9. 窗口自适应 ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>